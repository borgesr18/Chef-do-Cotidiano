module.exports=[51889,e=>{"use strict";e.s(["handler",()=>$,"patchFetch",()=>M,"routeModule",()=>k,"serverHooks",()=>H,"workAsyncStorage",()=>z,"workUnitAsyncStorage",()=>L],51889);var t=e.i(55913),r=e.i(8207),a=e.i(62877),i=e.i(42771),n=e.i(2542),o=e.i(77911),s=e.i(29900),d=e.i(40314),l=e.i(38223),u=e.i(99949),c=e.i(46916),p=e.i(88198),m=e.i(34734),g=e.i(83671),f=e.i(93695);e.i(65951);var h=e.i(77156);e.s(["DELETE",()=>T,"GET",()=>S,"POST",()=>I],75623);var R=e.i(45985),v=e.i(11943),w=e.i(43347),E=e.i(54799);let _={randomUUID:E.randomUUID},x=new Uint8Array(256),y=x.length,C=[];for(let e=0;e<256;++e)C.push((e+256).toString(16).slice(1));let N=function(e,t,r){if(_.randomUUID&&!t&&!e)return _.randomUUID();let a=(e=e||{}).random??e.rng?.()??(y>x.length-16&&((0,E.randomFillSync)(x),y=0),x.slice(y,y+=16));if(a.length<16)throw Error("Random bytes length must be >= 16");if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return(C[e[t+0]]+C[e[t+1]]+C[e[t+2]]+C[e[t+3]]+"-"+C[e[t+4]]+C[e[t+5]]+"-"+C[e[t+6]]+C[e[t+7]]+"-"+C[e[t+8]]+C[e[t+9]]+"-"+C[e[t+10]]+C[e[t+11]]+C[e[t+12]]+C[e[t+13]]+C[e[t+14]]+C[e[t+15]]).toLowerCase()}(a)};e.i(8997);var U=e.i(38339),A=e.i(21475);let b=(0,v.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY);function j(e,t){if(t)return t;let r=e.cookies.get("session_id");return r?.value?r.value:N()}async function q(e){try{let t=await e.json(),r=w.z.object({recipe_id:w.z.string().uuid("ID da receita inválido"),action:w.z.enum(["view","like","favorite","share","download"]),metadata:w.z.record(w.z.any()).optional()}),a=(0,A.validateData)(r,t);if(!a.success)return R.NextResponse.json({error:"Dados inválidos",details:a.errors},{status:400});let{recipe_id:i,action:n,metadata:o={}}=a.data,s=e.headers.get("authorization"),d=null;if(s){let e=s.replace("Bearer ",""),{data:{user:t}}=await b.auth.getUser(e);d=t?.id}let l=j(e),u={recipe_id:i,user_id:d,session_id:l,action:n,metadata:{...o,ip:function(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():r||"unknown"}(e),user_agent:e.headers.get("user-agent")||"unknown",timestamp:new Date().toISOString()}},{data:c,error:p}=await b.from("recipes").select("id").eq("id",i).single();if(p||!c)return R.NextResponse.json({error:"Receita não encontrada"},{status:404});if("favorite"===n){let{data:e}=await b.from("interactions").select("id").eq("recipe_id",i).eq("action","favorite").eq(d?"user_id":"session_id",d||l).single();if(e)return R.NextResponse.json({message:"Receita já está nos favoritos"},{status:200})}let{data:m,error:g}=await b.from("interactions").insert(u).select().single();if(g)return R.NextResponse.json({error:"Erro interno do servidor"},{status:500});let f=R.NextResponse.json({success:!0,interaction:{id:m.id,action:m.action,timestamp:m.created_at}});return e.cookies.get("session_id")||f.cookies.set("session_id",l,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:31536e3}),f}catch(e){if(e instanceof w.z.ZodError)return R.NextResponse.json({error:"Dados inválidos",details:e.errors.map(e=>({field:e.path.join("."),message:e.message}))},{status:400});return R.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function P(e){try{let{searchParams:t}=new URL(e.url),r={recipe_id:t.get("recipe_id"),action:t.get("action"),query:t.get("query"),page:t.get("page"),limit:t.get("limit"),sort_by:t.get("sort_by"),order:t.get("order")},a=w.z.object({recipe_id:w.z.string().uuid("ID da receita deve ser um UUID válido").optional(),action:w.z.enum(["view","like","favorite","share","download"],{errorMap:()=>({message:"Ação inválida"})}).optional(),query:w.z.string().min(1,"Termo de busca é obrigatório").max(100,"Termo de busca muito longo").optional(),page:w.z.coerce.number().min(1).default(1),limit:w.z.coerce.number().min(1).max(50).default(20),sort_by:w.z.enum(["created_at","action","recipe_id"]).default("created_at"),order:w.z.enum(["asc","desc"]).default("desc")}),i=(0,A.validateData)(a,r);if(!i.success)return R.NextResponse.json({error:"Parâmetros inválidos",details:i.errors},{status:400});let{recipe_id:n,action:o,query:s,page:d=1,limit:l=20,sort_by:u,order:c}=i.data,{data:{user:p}}=await b.auth.getUser(),m=(d-1)*l,g=b.from("interactions").select(`
        id,
        recipe_id,
        action,
        created_at,
        metadata,
        recipes(
          id,
          title,
          category,
          image_url
        )
      `);if(n&&(g=g.eq("recipe_id",n)),o&&(g=g.eq("action",o)),p)g=g.eq("user_id",p.id);else{let t=j(e);g=g.eq("session_id",t)}let{data:f,error:h}=await g.order("created_at",{ascending:"asc"===c}).range(m,m+l-1);if(h)return R.NextResponse.json({error:"Erro interno do servidor"},{status:500});return R.NextResponse.json({interactions:f||[],pagination:{page:d,limit:l,total:f?.length||0}})}catch(e){if(e instanceof w.z.ZodError)return R.NextResponse.json({error:"Parâmetros inválidos",details:e.errors.map(e=>({field:e.path.join("."),message:e.message}))},{status:400});return R.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function D(e){try{let{searchParams:t}=new URL(e.url),r={recipe_id:t.get("recipe_id")||t.get("recipeId"),action:t.get("action")},a=w.z.object({recipe_id:w.z.string().uuid("ID da receita deve ser um UUID válido"),action:w.z.enum(["view","like","favorite","share","download"],{errorMap:()=>({message:"Ação inválida"})})}),i=(0,A.validateData)(a,r);if(!i.success)return R.NextResponse.json({error:"Parâmetros inválidos",details:i.errors},{status:400});let{recipe_id:n,action:o}=i.data,{data:{user:s}}=await b.auth.getUser(),d=b.from("interactions").delete().eq("recipe_id",n).eq("action",o);if(s)d=d.eq("user_id",s.id);else{let t=j(e);d=d.eq("session_id",t)}let{error:l}=await d;if(l)return R.NextResponse.json({error:"Erro interno do servidor"},{status:500});return R.NextResponse.json({success:!0,message:"Interação removida com sucesso"})}catch(e){if(e instanceof w.z.ZodError)return R.NextResponse.json({error:"Parâmetros inválidos",details:e.errors.map(e=>({field:e.path.join("."),message:e.message}))},{status:400});return R.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let I=(0,U.withRateLimit)(q,U.rateLimitConfigs.mutation),S=(0,U.withRateLimit)(P,U.rateLimitConfigs.public),T=(0,U.withRateLimit)(D,U.rateLimitConfigs.mutation);var O=e.i(75623);let k=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/interactions/route",pathname:"/api/interactions",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/interactions/route.ts",nextConfigOutput:"standalone",userland:O}),{workAsyncStorage:z,workUnitAsyncStorage:L,serverHooks:H}=k;function M(){return(0,a.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:L})}async function $(e,t,a){var R;let v="/api/interactions/route";v=v.replace(/\/index$/,"")||"/";let w=await k.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:_,nextConfig:x,isDraftMode:y,prerenderManifest:C,routerServerContext:N,isOnDemandRevalidate:U,revalidateOnlyGenerated:A,resolvedPathname:b}=w,j=(0,o.normalizeAppPath)(v),q=!!(C.dynamicRoutes[j]||C.routes[b]);if(q&&!y){let e=!!C.routes[b],t=C.dynamicRoutes[j];if(t&&!1===t.fallback&&!e)throw new f.NoFallbackError}let P=null;!q||k.isDev||y||(P="/index"===(P=b)?"/":P);let D=!0===k.isDev||!q,I=q&&!D,S=e.method||"GET",T=(0,n.getTracer)(),O=T.getActiveScopeSpan(),z={params:_,prerenderManifest:C,renderOpts:{experimental:{cacheComponents:!!x.experimental.cacheComponents,authInterrupts:!!x.experimental.authInterrupts},supportsDynamicResponse:D,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(R=x.experimental)?void 0:R.cacheLife,isRevalidate:I,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>k.onRequestError(e,t,a,N)},sharedContext:{buildId:E}},L=new s.NodeNextRequest(e),H=new s.NodeNextResponse(t),M=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async r=>k.handle(M,z).finally(()=>{if(!r)return;r.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=T.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let e=`${S} ${i}`;r.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),r.updateName(e)}else r.updateName(`${S} ${e.url}`)}),s=async n=>{var s,d;let l=async({previousCacheEntry:r})=>{try{if(!(0,i.getRequestMeta)(e,"minimalMode")&&U&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=z.renderOpts.fetchMetrics;let d=z.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=z.renderOpts.collectedTags;if(!q)return await (0,c.sendResponse)(L,H,s,z.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,a=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:I,isOnDemandRevalidate:U})},N),t}},f=await k.handleResponse({req:e,nextConfig:x,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:U,revalidateOnlyGenerated:A,responseGenerator:l,waitUntil:a.waitUntil});if(!q)return null;if((null==f||null==(s=f.value)?void 0:s.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==f||null==(d=f.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,i.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",U?"REVALIDATED":f.isMiss?"MISS":f.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let R=(0,p.fromNodeOutgoingHttpHeaders)(f.value.headers);return(0,i.getRequestMeta)(e,"minimalMode")&&q||R.delete(g.NEXT_CACHE_TAGS_HEADER),!f.cacheControl||t.getHeader("Cache-Control")||R.get("Cache-Control")||R.set("Cache-Control",(0,m.getCacheControlHeader)(f.cacheControl)),await (0,c.sendResponse)(L,H,new Response(f.value.body,{headers:R,status:f.value.status||200})),null};O?await s(O):await T.withPropagatedContext(e.headers,()=>T.trace(l.BaseServerSpan.handleRequest,{spanName:`${S} ${e.url}`,kind:n.SpanKind.SERVER,attributes:{"http.method":S,"http.target":e.url}},s))}catch(t){if(O||t instanceof f.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:I,isOnDemandRevalidate:U})}),q)throw t;return await (0,c.sendResponse)(L,H,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=3d567_next_dist_esm_build_templates_app-route_a6bfb838.js.map